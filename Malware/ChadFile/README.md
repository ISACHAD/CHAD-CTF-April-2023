# ChadFile

Created by Felipe Pineda
Category: Easy

## Story
One of my co-workers sent me this PDF. I wonder what it does or had hidden within it as it doesn't have much on the sheet.

**This is not real malware, but we still recommend analyzing it in a VM.**

## Structure

The Challenge consists of a single PDF file.

## Overview
- The challenge teaches players how to look for malicious (not really malicious) code within a PDF file. 
- The PDF has embedded JS that runs when opened. It doesn't do anything bad, just prints out a hint message.
- The real challenge is looking within the actual internal of the PDFs. 
- Not a lot MAREs (Malware Analyst Reverse Engineers) look at PDFs. It's acutally a concept taught in GREM (SANS course),
- I learned how to make via knowledge of how to RE PDFs and research in crafting them (at a very very simple level)/
- Overall, I want players to learn the internals/skeleton of PDF. How it uses objects and streams to craft what you see in the PDF viewer of your choice.



## Solution/Walthrough

- The user can do all sorts of examinations to the pdf but I only had a few tools in mind that could be beneficial. Those are pdfid.py, pdf-parse.py, and peepdf.py

- These tools just id or parse through the pdf to find suspecting items. 

- Just as an FYI, the PDF was created with the tool peepdf.py (CLI). I created a simple pdf with open_action_js. This means on opening the file, it will run harmless JavaScript. The harmless JavaScript is just an alert with another hint of “reminder that the item that you are looking for isn’t initially visible. It requires some deflation/decompression ;)”. It may need to be ran on an Adobe product to the windows popup.

- I embedded (“wrote in”) the flag portion into the same object that the JavaScript resides in. I wrote it in as a comment.

- The hint given in the window popup leads the user to believe that there could be compressed data within the file. It’s a huge hint as that’s exactly what the PDF has within, compressed data. The hint also gives the user a keyword which is “deflation”

- Looking at the file, we can see that the PDF is structured in objects (defined by “obj # #”). Each object has a field called “Referencing”. When you research how to navigate PDFs, you’ll see that these objects will reference each other almost as a sort of linked list. One will call the other and so on. So where does it start? Well at the bottom, the user will be able to see the root object which is 1. See the tree structure below

- After looking at the PDF structure more, you can see that object 4 has JavaScript labels within it. So that’ll lead the user to believe that the file has Javascript. Object 4 points directly to object 5, which has a stream. PDF streams are normally known to be compressed. 

- After some googling around, the user will be able to see that the Object 5 has the compressed stream. There are multiple ways of decompressing the data, but using pdf-parser.py is the fastest.

```bash
$ pdf-parser ILOVEADOBE.pdf -o 5  --filter --raw 
obj 5 0
 Type: 
 Referencing: 
 Contains stream

  <<
    /Length 163
    /Filter /FlateDecode
  >>

 b'app.alert("reminder that the item that you are looking for isn\\\\\\\'t initially visible. It requires some deflation/decompression ;)", 3); // What you are looking for is --> CHAD{I+s_G!VING_M3_CHAD_V!B3S}'

```

- Using pdf-parser to apply the decompression filter will decompress the data.

- FlareDecode uses the zlib/deflate method to obtain the compress data.

- Another manner of obtaining the decompress data is detailed here: https://eternal-todo.com/blog/filters-flatedecode-pdf

- This “obfuscation” is considered extremely simple as it’s one of the normal techniques PDFs use to reduce the overall file size and avoid binary characters. This is why I cateogrized it as Easy. I can see how it would be a Medium if the player doesn't know enough about how PDFs work or overall doesn't understand decoding. A simple `cat` of the file will not work :)

FLAG: `CHAD{I+s_G!VING_M3_CHAD_V!B3S}`

# Hints
1. The item that you are looking for isn't initially visible. It requires some deflation/decompression ;) The Tool pdf-parser to deflate/decode may be helpful.

## Notes
- [Hiding Information in a PDF](https://eternal-todo.com/blog/filters-flatedecode-pdf)
- [How PDFs are Structured](https://www.oreilly.com/library/view/pdf-explained/9781449321581/ch04.html)
- [What are Object Streams](https://blog.idrsolutions.com/what-are-pdf-object-streams/)
- [PDF Stream Objects](https://blog.didierstevens.com/2008/05/19/pdf-stream-objects/)
- [Using peepdf.py and creating fun PDFs](https://code.google.com/archive/p/peepdf/wikis/Commands.wiki)
